<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HistÃ³rico de SaÃ­das - Frota Sanemar</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="/static/manifest.json">
    <style>
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }
        .pulse-dot {
            animation: pulse-dot 2s ease-in-out infinite;
        }
        
        /* Tabs de Categoria do HistÃ³rico */
        .historico-category-tab {
            background: #f3f4f6;
            color: #6b7280;
            border: 2px solid transparent;
        }
        .historico-category-tab:hover {
            background: #e5e7eb;
            color: #374151;
        }
        .historico-category-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .count-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.3);
        }
        .historico-category-tab.active .count-badge {
            background: rgba(255, 255, 255, 0.4);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    
    <!-- Header -->
    <header class="bg-white shadow-lg border-b-4 border-indigo-500">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">ğŸ“‹ HistÃ³rico de Viagens</h1>
                    <p class="text-sm text-gray-600 mt-1">Acompanhamento em tempo real</p>
                </div>
                <div class="flex items-center gap-3">
                    <!-- Indicador Tempo Real -->
                    <div class="flex items-center gap-2 bg-green-100 text-green-800 px-4 py-2 rounded-full">
                        <span class="w-3 h-3 bg-green-500 rounded-full pulse-dot"></span>
                        <span class="text-sm font-semibold">Tempo Real</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Filtros -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">ğŸ” Filtros</h2>
            
            <!-- Seletor de MÃªs/Ano -->
            <div class="mb-6 p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl border-2 border-indigo-200">
                <label class="block text-sm font-semibold text-gray-700 mb-3">ğŸ“… PerÃ­odo do HistÃ³rico</label>
                <div class="flex gap-3 items-center flex-wrap">
                    <button type="button" id="mes-anterior" 
                            class="px-4 py-2 bg-white hover:bg-indigo-100 border-2 border-indigo-300 rounded-lg font-bold text-indigo-700 transition-all transform hover:scale-105">
                        â—€ MÃªs Anterior
                    </button>
                    <div class="flex gap-2 items-center">
                        <select id="filtro-mes" 
                                class="px-4 py-2 rounded-lg border-2 border-indigo-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all font-semibold">
                            <option value="1">Janeiro</option>
                            <option value="2">Fevereiro</option>
                            <option value="3">MarÃ§o</option>
                            <option value="4">Abril</option>
                            <option value="5">Maio</option>
                            <option value="6">Junho</option>
                            <option value="7">Julho</option>
                            <option value="8">Agosto</option>
                            <option value="9">Setembro</option>
                            <option value="10">Outubro</option>
                            <option value="11">Novembro</option>
                            <option value="12">Dezembro</option>
                        </select>
                        <select id="filtro-ano" 
                                class="px-4 py-2 rounded-lg border-2 border-indigo-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all font-semibold">
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                        </select>
                    </div>
                    <button type="button" id="mes-proximo" 
                            class="px-4 py-2 bg-white hover:bg-indigo-100 border-2 border-indigo-300 rounded-lg font-bold text-indigo-700 transition-all transform hover:scale-105">
                        PrÃ³ximo MÃªs â–¶
                    </button>
                    <button type="button" id="mes-atual" 
                            class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold transition-all transform hover:scale-105">
                        ğŸ“… MÃªs Atual
                    </button>
                </div>
            </div>

            <!-- Filtros Adicionais -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">ğŸ“… Data EspecÃ­fica</label>
                    <input type="date" id="filtro-data" 
                           class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">ğŸš— VeÃ­culo</label>
                    <input type="text" id="filtro-placa" placeholder="Placa..."
                           class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all uppercase">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">ğŸ‘¤ Motorista</label>
                    <input type="text" id="filtro-motorista" placeholder="Nome..."
                           class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all">
                </div>
                <div class="flex items-end">
                    <button id="limpar-filtros" 
                            class="w-full px-6 py-3 bg-gray-200 hover:bg-gray-300 rounded-xl font-bold transition-all transform hover:scale-105">
                        ğŸ”„ Limpar
                    </button>
                </div>
            </div>
            
            <!-- Tabs de Categorias -->
            <div class="mt-6">
                <div class="flex flex-wrap gap-2 border-b-2 border-gray-200 pb-2">
                    <button onclick="trocarCategoria('todos')" class="historico-category-tab active px-4 py-2 rounded-t-lg font-semibold text-sm transition-all" data-category="todos">
                        ğŸŒ Todos <span class="count-badge ml-1"></span>
                    </button>
                    <button onclick="trocarCategoria('Base ETE de AraÃ§atiba')" class="historico-category-tab px-4 py-2 rounded-t-lg font-semibold text-sm transition-all" data-category="Base ETE de AraÃ§atiba">
                        ğŸ“ AraÃ§atiba <span class="count-badge ml-1"></span>
                    </button>
                    <button onclick="trocarCategoria('Vans')" class="historico-category-tab px-4 py-2 rounded-t-lg font-semibold text-sm transition-all" data-category="Vans">
                        ğŸš Vans <span class="count-badge ml-1"></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- EstatÃ­sticas RÃ¡pidas -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="bg-gradient-to-br from-yellow-400 to-orange-500 rounded-2xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-semibold opacity-90">Em Curso Agora</p>
                        <p class="text-4xl font-bold mt-2" id="stat-em-curso">-</p>
                    </div>
                    <div class="text-5xl opacity-20">ğŸš—</div>
                </div>
            </div>
            <div class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-semibold opacity-90">Viagens Hoje</p>
                        <p class="text-4xl font-bold mt-2" id="stat-hoje">-</p>
                    </div>
                    <div class="text-5xl opacity-20">ğŸ“Š</div>
                </div>
            </div>
            <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-semibold opacity-90">Total do MÃªs</p>
                        <p class="text-4xl font-bold mt-2" id="stat-total">-</p>
                    </div>
                    <div class="text-5xl opacity-20">ğŸ“‹</div>
                </div>
            </div>
            <div class="bg-gradient-to-br from-purple-500 to-pink-600 rounded-2xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-semibold opacity-90">Mostrando</p>
                        <p class="text-4xl font-bold mt-2" id="stat-mostrando">-</p>
                    </div>
                    <div class="text-5xl opacity-20">ğŸ‘ï¸</div>
                </div>
            </div>
        </div>
        
        <!-- Aviso de limite atingido -->
        <div id="aviso-limite" class="hidden bg-yellow-50 border-l-4 border-yellow-500 rounded-lg p-4 mb-6">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-yellow-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-semibold text-yellow-800">
                        âš ï¸ Limite de 500 registros atingido
                    </p>
                    <p class="text-sm text-yellow-700 mt-1">
                        Mostrando os 500 registros mais recentes deste mÃªs. Use os filtros adicionais (data especÃ­fica, veÃ­culo ou motorista) para refinar sua busca.
                    </p>
                </div>
            </div>
        </div>

        <!-- Tabela de HistÃ³rico -->
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-900">ğŸ“œ Registros</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white">
                        <tr>
                            <th class="px-6 py-4 text-left text-sm font-bold">Status</th>
                            <th class="px-6 py-4 text-left text-sm font-bold">VeÃ­culo</th>
                            <th class="px-6 py-4 text-left text-sm font-bold">Motorista</th>
                            <th class="px-6 py-4 text-left text-sm font-bold">Solicitante</th>
                            <th class="px-6 py-4 text-left text-sm font-bold">SaÃ­da</th>
                            <th class="px-6 py-4 text-left text-sm font-bold">Chegada</th>
                            <th class="px-6 py-4 text-left text-sm font-bold">Trajeto</th>
                            <th class="px-6 py-4 text-center text-sm font-bold">AÃ§Ãµes</th>
                        </tr>
                    </thead>
                    <tbody id="tabela-historico" class="divide-y divide-gray-100">
                        <tr>
                            <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                                <div class="flex flex-col items-center gap-3">
                                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"></div>
                                    <p>Carregando histÃ³rico...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>

    <!-- Modal de EdiÃ§Ã£o -->
    <div id="modal-editar" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 rounded-t-2xl">
                <h2 class="text-2xl font-bold">âœï¸ Editar SaÃ­da</h2>
            </div>
            <form id="form-editar" class="p-6">
                <input type="hidden" id="edit-saida-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">ğŸš— VeÃ­culo (Placa)</label>
                        <input type="text" id="edit-veiculo" required
                               class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all uppercase">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">ğŸ‘¤ Motorista</label>
                        <input type="text" id="edit-motorista" required
                               class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">ğŸ‘” Solicitante</label>
                    <input type="text" id="edit-solicitante" required
                           class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">ğŸ“ Trajeto</label>
                    <input type="text" id="edit-trajeto" required
                           class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">ğŸ• SaÃ­da</label>
                        <input type="datetime-local" id="edit-timestamp-saida" required
                               class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">ğŸ• Chegada</label>
                        <input type="datetime-local" id="edit-timestamp-chegada"
                               class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all">
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">ğŸ“Š Status</label>
                    <select id="edit-status" required
                            class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all">
                        <option value="em_curso">Em Curso</option>
                        <option value="finalizada">Finalizada</option>
                    </select>
                </div>

                <div class="flex gap-3">
                    <button type="submit" 
                            class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-xl font-bold transition-all transform hover:scale-105">
                        ğŸ’¾ Salvar
                    </button>
                    <button type="button" onclick="fecharModalEditar()" 
                            class="flex-1 px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-xl font-bold transition-all">
                        âŒ Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase Config -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, query, orderBy, limit, onSnapshot, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // ConfiguraÃ§Ã£o do Firebase (pegue do seu firebase-credentials.json)
        const firebaseConfig = {
            apiKey: "AIzaSyABpZYGgQ_qp2uxkZPFXR_w2_Dz8wOoYkY",
            authDomain: "frota-sanemar.firebaseapp.com",
            projectId: "frota-sanemar",
            storageBucket: "frota-sanemar.firebasestorage.app",
            messagingSenderId: "452765831068",
            appId: "1:452765831068:web:d3b1e9f35f8f3e0f8c8f3e"
        };

        // Inicializa Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // VariÃ¡veis globais
        let unsubscribe = null;
        let todosRegistros = [];
        let mesAtual = new Date().getMonth() + 1;  // 1-12
        let anoAtual = new Date().getFullYear();
        let categoriaAtiva = 'todos'; // Categoria de filtro

        // Inicializa os seletores de mÃªs/ano com a data atual
        function inicializarFiltrosMesAno() {
            document.getElementById('filtro-mes').value = mesAtual;
            document.getElementById('filtro-ano').value = anoAtual;
        }

        // Parser de data robusto
        function parseDateValue(val) {
            if (!val && val !== 0) return null;
            if (typeof val === 'object' && val !== null) {
                if (val.seconds) return new Date(val.seconds * 1000);
                if (val._seconds) return new Date(val._seconds * 1000);
            }
            if (typeof val === 'number') {
                const d = new Date(val);
                if (!isNaN(d.getTime())) return d;
            }
            if (typeof val === 'string') {
                let d = new Date(val);
                if (!isNaN(d.getTime())) return d;
            }
            return null;
        }

        // Formatar data
        function formatarData(val) {
            const d = parseDateValue(val);
            if (!d) return '-';
            const dia = String(d.getDate()).padStart(2, '0');
            const mes = String(d.getMonth() + 1).padStart(2, '0');
            const ano = d.getFullYear();
            const horas = String(d.getHours()).padStart(2, '0');
            const minutos = String(d.getMinutes()).padStart(2, '0');
            return `${dia}/${mes}/${ano} ${horas}:${minutos}`;
        }

        // FunÃ§Ã£o para mostrar toast de notificaÃ§Ã£o
        function mostrarToast(mensagem, tipo = 'info') {
            // Cria elemento do toast
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 px-6 py-4 rounded-lg shadow-lg text-white font-semibold z-50 transform transition-all duration-300 ${
                tipo === 'success' ? 'bg-green-500' : 
                tipo === 'error' ? 'bg-red-500' : 
                'bg-blue-500'
            }`;
            toast.textContent = mensagem;
            toast.style.transform = 'translateX(400px)';
            
            document.body.appendChild(toast);
            
            // Anima entrada
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 10);
            
            // Remove apÃ³s 3 segundos
            setTimeout(() => {
                toast.style.transform = 'translateX(400px)';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // Disponibiliza globalmente
        window.mostrarToast = mostrarToast;

        // Atualiza os badges de contagem de cada categoria
        function atualizarBadgesCategorias() {
            const contadores = {
                'todos': 0,
                'Base ETE de AraÃ§atiba': 0,
                'Vans': 0
            };
            
            // Conta registros por categoria
            todosRegistros.forEach(r => {
                const categoria = r.veiculo_categoria || r.categoria || '';
                contadores['todos']++;
                if (categoria === 'Base ETE de AraÃ§atiba') {
                    contadores['Base ETE de AraÃ§atiba']++;
                } else if (categoria === 'Vans') {
                    contadores['Vans']++;
                }
            });
            
            // Atualiza os badges
            document.querySelectorAll('.historico-category-tab').forEach(tab => {
                const categoria = tab.getAttribute('data-category');
                const badge = tab.querySelector('.count-badge');
                if (badge && contadores[categoria] !== undefined) {
                    badge.textContent = contadores[categoria];
                }
            });
        }

        // Atualiza estatÃ­sticas
        function atualizarStats(registros) {
            const emCurso = registros.filter(r => r.status === 'em_curso').length;
            const hoje = registros.filter(r => {
                const ts = parseDateValue(r.timestampSaida);
                if (!ts) return false;
                const hoje = new Date();
                return ts.getDate() === hoje.getDate() && 
                       ts.getMonth() === hoje.getMonth() && 
                       ts.getFullYear() === hoje.getFullYear();
            }).length;

            document.getElementById('stat-em-curso').textContent = emCurso;
            document.getElementById('stat-hoje').textContent = hoje;
            document.getElementById('stat-total').textContent = todosRegistros.length;
            document.getElementById('stat-mostrando').textContent = registros.length;
            
            // Mostra aviso se chegou no limite de 500
            const avisoLimite = document.getElementById('aviso-limite');
            if (todosRegistros.length >= 500) {
                avisoLimite.classList.remove('hidden');
            } else {
                avisoLimite.classList.add('hidden');
            }
            
            // Atualiza badges de categorias
            atualizarBadgesCategorias();
        }

        // Renderiza tabela
        function renderizarTabela(registros) {
            const tbody = document.getElementById('tabela-historico');
            tbody.innerHTML = '';

            if (!registros || registros.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                            Nenhum registro encontrado
                        </td>
                    </tr>
                `;
                return;
            }

            registros.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-indigo-50 transition-colors';

                // Status
                const statusClass = item.status === 'em_curso' 
                    ? 'bg-yellow-100 text-yellow-800' 
                    : 'bg-green-100 text-green-800';
                const statusText = item.status === 'em_curso' ? 'Em Curso' : 'Finalizada';

                tr.innerHTML = `
                    <td class="px-6 py-4">
                        <span class="px-3 py-1 rounded-full text-xs font-bold ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-6 py-4 font-bold text-gray-900">${item.veiculo || '-'}</td>
                    <td class="px-6 py-4 text-gray-700">${item.motorista || '-'}</td>
                    <td class="px-6 py-4 text-gray-700">${item.solicitante || '-'}</td>
                    <td class="px-6 py-4 text-gray-600">${formatarData(item.timestampSaida)}</td>
                    <td class="px-6 py-4 text-gray-600">${item.timestampChegada ? formatarData(item.timestampChegada) : '-'}</td>
                    <td class="px-6 py-4 text-gray-600">${item.trajeto || '-'}</td>
                    <td class="px-6 py-4">
                        <div class="flex gap-2 justify-center">
                            <button onclick="editarSaida('${item.id}')" class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-semibold transition-all" title="Editar">
                                âœï¸
                            </button>
                            <button onclick="excluirSaida('${item.id}', '${item.veiculo}', '${item.motorista}')" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-semibold transition-all" title="Excluir">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            atualizarStats(registros);
        }

        // Aplica filtros
        function aplicarFiltros() {
            const data = document.getElementById('filtro-data').value;
            const placa = document.getElementById('filtro-placa').value.toUpperCase().trim();
            const motorista = document.getElementById('filtro-motorista').value.toUpperCase().trim();
            
            // Detecta qual botÃ£o estÃ¡ ativo para cada tipo de filtro
            let filtroAprovacao = '';
            if (document.getElementById('btn-aprovado')?.classList.contains('bg-purple-500')) {
                filtroAprovacao = 'aprovado';
            } else if (document.getElementById('btn-falta-aprovacao')?.classList.contains('bg-purple-500')) {
                filtroAprovacao = 'falta_aprovacao';
            } else if (document.getElementById('btn-sem-direcionamento')?.classList.contains('bg-purple-500')) {
                filtroAprovacao = 'sem_direcionamento';
            }
            
            let filtroDirecionamento = '';
            if (document.getElementById('btn-direcionado')?.classList.contains('bg-blue-500')) {
                filtroDirecionamento = 'direcionado';
            } else if (document.getElementById('btn-nao-direcionado')?.classList.contains('bg-blue-500')) {
                filtroDirecionamento = 'nao_direcionado';
            }
            
            let filtroPosDirecionamento = '';
            if (document.getElementById('btn-pos-aprovado')?.classList.contains('bg-indigo-500')) {
                filtroPosDirecionamento = 'aprovado';
            } else if (document.getElementById('btn-pos-falta')?.classList.contains('bg-indigo-500')) {
                filtroPosDirecionamento = 'falta_aprovacao';
            }

            let filtrados = [...todosRegistros];

            // Filtro de categoria - SEMPRE filtra apenas AraÃ§atiba e Vans
            filtrados = filtrados.filter(r => {
                const categoria = r.veiculo_categoria || r.categoria || '';
                
                if (categoriaAtiva === 'todos') {
                    // "Todos" mostra apenas AraÃ§atiba + Vans
                    return categoria === 'Base ETE de AraÃ§atiba' || categoria === 'Vans';
                } else {
                    // Categoria especÃ­fica
                    return categoria === categoriaAtiva;
                }
            });

            renderizarTabela(filtrados);
        }

        // Carrega dados do backend (com cache de 5 minutos)
        async function carregarHistorico() {
            try {
                // Pega mÃªs e ano dos seletores
                const mes = document.getElementById('filtro-mes').value;
                const ano = document.getElementById('filtro-ano').value;
                
                // Se houver data especÃ­fica, usa ela; senÃ£o usa mÃªs/ano
                
                if (!data || data.error) {
                    throw new Error(data.error || 'Erro ao carregar dados');
                }

                todosRegistros = data.historico || data;

                // Ordena: em_curso primeiro, depois por data
                todosRegistros.sort((a, b) => {
                    if (a.status === 'em_curso' && b.status !== 'em_curso') return -1;
                    if (a.status !== 'em_curso' && b.status === 'em_curso') return 1;
                    const tsA = parseDateValue(a.timestampSaida);
                    const tsB = parseDateValue(b.timestampSaida);
                    return tsB - tsA;
                });

                aplicarFiltros();
                
                // Atualiza o tÃ­tulo para mostrar o perÃ­odo
                const meses = ['Janeiro', 'Fevereiro', 'MarÃ§o', 'Abril', 'Maio', 'Junho', 
                              'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                const mesNome = meses[parseInt(mes) - 1];
                console.log(`âœ… HistÃ³rico de ${mesNome}/${ano} carregado (${todosRegistros.length} registros)`);
            } catch (error) {
                console.error('âŒ Erro ao carregar histÃ³rico:', error);
                showToast('error', 'Erro ao carregar histÃ³rico');
            }
        }

        // Listener LEVE: apenas notifica mudanÃ§as em veÃ­culos EM CURSO
        function iniciarRealtimeListener() {
            // âœ… OTIMIZADO: Query apenas para veÃ­culos EM CURSO (5-10 docs max)
            const q = query(
                collection(db, 'saidas'),
                where('status', '==', 'em_curso')
            );

            let isFirstSnapshot = true;

            unsubscribe = onSnapshot(q, (snapshot) => {
                console.log('ğŸ“Š AtualizaÃ§Ã£o em veÃ­culos EM CURSO:', snapshot.docChanges().length, 'mudanÃ§as');

                // Atualiza contador de em curso em tempo real
                const emCurso = snapshot.size;
                document.getElementById('stat-em-curso').textContent = emCurso;

                // Detecta mudanÃ§as importantes
                let houveAlteracao = false;

                snapshot.docChanges().forEach((change) => {
                    const data = change.doc.data();
                    
                    if (change.type === 'added' && !isFirstSnapshot) {
                        // Nova saÃ­da registrada
                        houveAlteracao = true;
                        showToast('info', `ğŸš— Nova saÃ­da: ${data.veiculo} - ${data.motorista}`);
                    } else if (change.type === 'removed') {
                        // Chegada registrada (removido de em_curso)
                        houveAlteracao = true;
                        showToast('success', `âœ… Chegada: ${data.veiculo}`);
                    }
                });

                // Se houve mudanÃ§a, recarrega do backend (usa cache se ainda vÃ¡lido)
                if (houveAlteracao) {
                    console.log('ğŸ”„ Recarregando histÃ³rico...');
                    carregarHistorico();
                }

                isFirstSnapshot = false;
            }, (error) => {
                console.error('âŒ Erro no listener:', error);
                showToast('error', 'Erro ao conectar com o banco de dados');
            });
        }

        // Toast notifications
        function showToast(type, message, duration = 3000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const colors = {
            };

            toast.className = `${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-0`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.transform = 'translateX(400px)';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Event listeners
        document.getElementById('filtro-mes').addEventListener('change', carregarHistorico);
        document.getElementById('filtro-ano').addEventListener('change', carregarHistorico);
        document.getElementById('filtro-data').addEventListener('change', aplicarFiltros);
        document.getElementById('filtro-placa').addEventListener('input', aplicarFiltros);
        document.getElementById('filtro-motorista').addEventListener('input', aplicarFiltros);
        document.getElementById('filtro-aprovacao').addEventListener('change', aplicarFiltros);
        document.getElementById('filtro-direcionamento').addEventListener('change', aplicarFiltros);
        document.getElementById('filtro-pos-direcionamento').addEventListener('change', aplicarFiltros);
        
        // NavegaÃ§Ã£o de mÃªs
        document.getElementById('mes-anterior').addEventListener('click', () => {
            let mes = parseInt(document.getElementById('filtro-mes').value);
            let ano = parseInt(document.getElementById('filtro-ano').value);
            
            mes--;
            if (mes < 1) {
                mes = 12;
                ano--;
            }
            
            document.getElementById('filtro-mes').value = mes;
            document.getElementById('filtro-ano').value = ano;
            carregarHistorico();
        });
        
        document.getElementById('mes-proximo').addEventListener('click', () => {
            let mes = parseInt(document.getElementById('filtro-mes').value);
            let ano = parseInt(document.getElementById('filtro-ano').value);
            
            mes++;
            
            if (mes > 12) {
                mes = 1;
                ano++;
            }
            
            document.getElementById('filtro-mes').value = mes;
            document.getElementById('filtro-ano').value = ano;
            carregarHistorico();
        });
        
        document.getElementById('mes-atual').addEventListener('click', () => {
            const hoje = new Date();
            document.getElementById('filtro-mes').value = hoje.getMonth() + 1;
            document.getElementById('filtro-ano').value = hoje.getFullYear();
            carregarHistorico();
        });
        
        document.getElementById('limpar-filtros').addEventListener('click', () => {
            document.getElementById('filtro-data').value = '';
            document.getElementById('filtro-placa').value = '';
            document.getElementById('filtro-motorista').value = '';
            aplicarFiltros();
        });

        // ForÃ§a uppercase no input de placa
        document.getElementById('filtro-placa').addEventListener('input', (e) => {
            const pos = e.target.selectionStart;
            e.target.value = e.target.value.toUpperCase();
            e.target.setSelectionRange(pos, pos);
        });

        // Cleanup ao sair
        window.addEventListener('beforeunload', () => {
            if (unsubscribe) unsubscribe();
        });

        // Inicia: inicializa filtros, carrega dados primeiro, depois ativa listener
        inicializarFiltrosMesAno();
        carregarHistorico();
        iniciarRealtimeListener();
        
        // FunÃ§Ãµes globais para editar/excluir
        window.editarSaida = async function(saidaId) {
            const saida = todosRegistros.find(s => s.id === saidaId);
            if (!saida) {
                mostrarToast('Registro nÃ£o encontrado', 'error');
                return;
            }

            // Preenche o formulÃ¡rio
            document.getElementById('edit-saida-id').value = saidaId;
            document.getElementById('edit-veiculo').value = saida.veiculo || '';
            document.getElementById('edit-motorista').value = saida.motorista || '';
            document.getElementById('edit-solicitante').value = saida.solicitante || '';
            document.getElementById('edit-trajeto').value = saida.trajeto || '';
            document.getElementById('edit-status').value = saida.status || 'em_curso';
            
            // Novos campos de aprovaÃ§Ã£o e direcionamento
            document.getElementById('edit-status-aprovacao').value = saida.status_aprovacao || '';
            document.getElementById('edit-status-direcionamento').value = saida.status_direcionamento || '';
            document.getElementById('edit-status-pos-direcionamento').value = saida.status_pos_direcionamento || '';
            document.getElementById('edit-observacoes').value = saida.observacoes || '';

            // Converte timestamps para datetime-local
            const saida_date = parseDateValue(saida.timestampSaida);
            if (saida_date) {
                document.getElementById('edit-timestamp-saida').value = formatDatetimeLocal(saida_date);
            }

            const chegada_date = parseDateValue(saida.timestampChegada);
            if (chegada_date) {
                document.getElementById('edit-timestamp-chegada').value = formatDatetimeLocal(chegada_date);
            }

            // Mostra modal
            document.getElementById('modal-editar').classList.remove('hidden');
        };

        window.excluirSaida = async function(saidaId, veiculo, motorista) {
            if (!confirm(`âš ï¸ Confirma exclusÃ£o da saÃ­da?\n\nVeÃ­culo: ${veiculo}\nMotorista: ${motorista}\n\nEsta aÃ§Ã£o nÃ£o pode ser desfeita!`)) {
                return;
            }

            try {
                const response = await fetch(`/api/saidas/${saidaId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    mostrarToast('âœ… Registro excluÃ­do com sucesso', 'success');
                    carregarHistorico();
                } else {
                    mostrarToast(`âŒ Erro: ${result.error || 'Falha ao excluir'}`, 'error');
                }
            } catch (error) {
                console.error('Erro ao excluir:', error);
                mostrarToast('âŒ Erro ao excluir registro', 'error');
            }
        };

        window.fecharModalEditar = function() {
            document.getElementById('modal-editar').classList.add('hidden');
            document.getElementById('form-editar').reset();
        };

        // Helper para converter Date para datetime-local format
        function formatDatetimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // Submit do formulÃ¡rio de ediÃ§Ã£o
        const formEditar = document.getElementById('form-editar');
        if (formEditar) {
            console.log('âœ… FormulÃ¡rio de ediÃ§Ã£o encontrado, registrando listener...');
            formEditar.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('ğŸ”„ Iniciando ediÃ§Ã£o...');

                const saidaId = document.getElementById('edit-saida-id').value;
                console.log('ğŸ“ ID da saÃ­da:', saidaId);
            
            // Converte datetime-local para ISO mantendo timezone local
            const saidaInput = document.getElementById('edit-timestamp-saida').value;
            const chegadaInput = document.getElementById('edit-timestamp-chegada').value;
            
            // IMPORTANTE: datetime-local nÃ£o tem timezone, entÃ£o forÃ§amos interpretaÃ§Ã£o como local
            // Adiciona timezone offset para evitar conversÃ£o UTC incorreta
            const saidaISO = saidaInput ? saidaInput + ':00' : null;
            const chegadaISO = chegadaInput ? chegadaInput + ':00' : null;
            
            const dados = {
                veiculo: document.getElementById('edit-veiculo').value.toUpperCase(),
                motorista: document.getElementById('edit-motorista').value,
                solicitante: document.getElementById('edit-solicitante').value,
                trajeto: document.getElementById('edit-trajeto').value,
                status: document.getElementById('edit-status').value,
                timestampSaida: saidaISO,
                timestampChegada: chegadaISO
            };

            try {
                const response = await fetch(`/api/saidas/${saidaId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dados)
                });

                const result = await response.json();

                if (response.ok) {
                    console.log('âœ… Salvou com sucesso');
                    mostrarToast('âœ… Registro atualizado com sucesso', 'success');
                    
                    const modal = document.getElementById('modal-editar');
                    if (modal) {
                        modal.classList.add('hidden');
                        console.log('âœ… Modal fechado');
                    }
                    
                    // âœ… Reset do formulÃ¡rio
                    const form = document.getElementById('form-editar');
                    if (form) {
                        form.reset();
                        console.log('âœ… FormulÃ¡rio resetado');
                    }
                    
                    // âœ… Recarrega os dados do histÃ³rico em background
                    carregarHistorico().catch(err => console.error('Erro ao recarregar:', err));
                } else {
                    mostrarToast(`âŒ Erro: ${result.error || 'Falha ao atualizar'}`, 'error');
                }
            } catch (error) {
                console.error('Erro ao atualizar:', error);
                mostrarToast('âŒ Erro ao atualizar registro', 'error');
            }
        });
    } else {
        console.error('âŒ FormulÃ¡rio de ediÃ§Ã£o nÃ£o encontrado!');
    }

        // Force uppercase no campo veÃ­culo do modal
        document.getElementById('edit-veiculo').addEventListener('input', (e) => {
            const pos = e.target.selectionStart;
            e.target.value = e.target.value.toUpperCase();
            e.target.setSelectionRange(pos, pos);
        });
        
        // FunÃ§Ã£o para trocar categoria ativa
        function trocarCategoria(categoria) {
            categoriaAtiva = categoria;
            
            // Atualiza visual dos botÃµes
            document.querySelectorAll('.historico-category-tab').forEach(tab => {
                if (tab.getAttribute('data-category') === categoria) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // Aplica filtros
            aplicarFiltros();
        }
        
        // ExpÃµe funÃ§Ãµes globalmente
        window.trocarCategoria = trocarCategoria;
        window.editarSaida = editarSaida;
        window.excluirSaida = excluirSaida;
    </script>
</body>
</html>
