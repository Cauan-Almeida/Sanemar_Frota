<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{{ placa }} - Detalhes</title>
<link rel="icon" type="image/x-icon" href="/static/favicon.ico">
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
</style>
</head>
<body class="min-h-screen">
<div class="flex flex-col md:flex-row min-h-screen">
<aside class="w-full md:w-64 bg-gray-800 text-white">
<div class="p-4 text-xl md:text-2xl font-bold border-b border-gray-700"><a href="/">Gest√£o de Frota</a></div>
<nav class="p-4 space-y-2">
<a href="/dashboard" class="block p-3 rounded-lg hover:bg-gray-600 text-sm md:text-base">üìä Dashboard</a>
<a href="/motoristas" class="block p-3 rounded-lg hover:bg-gray-600 text-sm md:text-base">üë§ Motoristas</a>
<a href="/veiculos" class="block p-3 rounded-lg bg-gray-700 text-sm md:text-base">üöó Ve√≠culos</a>
<a href="/" class="block p-3 rounded-lg hover:bg-gray-600 text-sm md:text-base">üìù Lan√ßamentos</a>
</nav>
</aside>
<div class="flex-1">
<header class="bg-white shadow p-3 md:p-4 flex items-center justify-between flex-wrap gap-3">
<h1 class="text-lg md:text-2xl font-bold">{{ placa }}</h1>
<div class="flex gap-2">
<a href="/pdf/abastecimentos?veiculo={{ placa }}" target="_blank" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 md:px-4 md:py-2 rounded-lg font-semibold text-xs md:text-sm">
üìÑ PDF
</a>
<button id="btn-abastecer" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 md:px-6 md:py-3 rounded-lg font-semibold text-xs md:text-base">‚õΩ Abastecer</button>
</div>
</header>
<main class="p-3 md:p-6 overflow-y-auto">
<div class="bg-white p-4 md:p-6 rounded-xl shadow mb-4">
<div class="grid grid-cols-2 md:grid-cols-4 gap-3">
<div><h3 class="text-gray-500 text-xs md:text-sm">Data Cadastro</h3><p class="text-sm md:text-lg font-semibold">{{ timestamp | formatar_data if timestamp else '-' }}</p></div>
<div><h3 class="text-gray-500 text-xs md:text-sm">Viagens</h3><p class="text-sm md:text-lg font-semibold">{{ total_viagens }}</p></div>
<div><h3 class="text-gray-500 text-xs md:text-sm">Horas</h3><p class="text-sm md:text-lg font-semibold">{{ horas_viagens }}h</p></div>
<div><h3 class="text-gray-500 text-xs md:text-sm">Od√¥metro</h3><p id="metric-ultimo-odometro" class="text-sm md:text-lg font-semibold">-</p></div>
</div>
</div>
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
<div class="p-4 md:p-6 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl text-white shadow-xl">
<div class="flex items-center justify-between mb-2"><div class="text-xs md:text-sm opacity-90">Consumo (km/L)</div><span class="text-xl">üìä</span></div>
<div id="metric-kmpl" class="text-2xl md:text-3xl font-bold mb-2">0.00</div>
<div class="border-t border-white border-opacity-30 pt-2">
<label class="block text-xs opacity-90 mb-2">Manual:</label>
<div class="flex gap-2">
<input type="number" step="0.01" id="input-media-kmpl" placeholder="0.00" class="flex-1 px-2 py-1 rounded text-gray-800 text-xs">
<button id="save-media-kmpl" class="px-3 py-1 bg-white text-blue-600 rounded font-semibold hover:bg-blue-50 text-xs">OK</button>
</div>
</div>
</div>
<div class="p-4 md:p-6 bg-gradient-to-br from-green-500 to-green-600 rounded-2xl text-white shadow-xl">
<div class="flex items-center justify-between mb-2"><div class="text-xs md:text-sm opacity-90">Total Litros</div><span class="text-xl">‚õΩ</span></div>
<div id="metric-total-litros" class="text-2xl md:text-3xl font-bold">-</div>
</div>
<div class="p-4 md:p-6 bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl text-white shadow-xl">
<div class="flex items-center justify-between mb-2"><div class="text-xs md:text-sm opacity-90">Km Rodados</div><span class="text-xl">üõ£Ô∏è</span></div>
<div id="metric-km-rodados" class="text-2xl md:text-3xl font-bold">-</div>
</div>
</div>
<div class="bg-white p-4 md:p-6 rounded-xl shadow mb-4">
<h2 class="text-lg md:text-xl font-semibold mb-4">Hist√≥rico de Abastecimentos</h2>
<div class="overflow-x-auto">
<table class="w-full text-left min-w-[600px]">
<thead class="bg-gray-50">
<tr>
<th class="p-2 text-xs md:text-sm">Data/Hora</th>
<th class="p-2 text-xs md:text-sm">Motorista</th>
<th class="p-2 text-xs md:text-sm">Litros</th>
<th class="p-2 text-xs md:text-sm">Od√¥metro</th>
<th class="p-2 text-xs md:text-sm hidden md:table-cell">Observa√ß√£o</th>
<th class="p-2 text-xs md:text-sm">A√ß√µes</th>
</tr>
</thead>
<tbody id="refuels-tbody">
<tr><td colspan="6" class="text-center p-4 text-gray-500 text-sm">Carregando...</td></tr>
</tbody>
</table>
</div>
<div class="flex flex-col md:flex-row items-center justify-between mt-4 gap-3">
<div class="flex items-center gap-2">
<label class="text-xs md:text-sm font-semibold">Linhas:</label>
<select id="refuels-page-size" class="px-2 py-1 rounded border-2 border-gray-200 text-xs">
<option value="5">5</option>
<option value="10" selected>10</option>
<option value="20">20</option>
</select>
</div>
<div id="refuels-pagination" class="flex items-center gap-2"></div>
</div>
</div>
<div class="bg-white p-4 md:p-6 rounded-xl shadow">
<h2 class="text-lg md:text-xl font-semibold mb-4">Hist√≥rico de Viagens</h2>
<div class="overflow-x-auto">
<table class="w-full text-left min-w-[600px]">
<thead class="bg-gray-50">
<tr>
<th class="p-2 text-xs">Status</th>
<th class="p-2 text-xs">Motorista</th>
<th class="p-2 text-xs">Sa√≠da</th>
<th class="p-2 text-xs">Chegada</th>
<th class="p-2 text-xs">Trajeto</th>
</tr>
</thead>
<tbody>
{% if saidas and saidas|length > 0 %}
{% for s in saidas %}
<tr class="hover:bg-gray-50 border-b">
<td class="p-2"><span class="px-2 py-1 rounded-full text-xs font-medium {% if s.status == 'finalizada' %}bg-green-100 text-green-800{% else %}bg-yellow-100 text-yellow-800{% endif %}">{{ s.status | replace('_', ' ') | title if s.status else '-' }}</span></td>
<td class="p-2 text-xs">{{ s.motorista }}</td>
<td class="p-2 text-xs">{{ s.saida | formatar_data }}</td>
<td class="p-2 text-xs">{{ s.chegada | formatar_data if s.chegada else '-' }}</td>
<td class="p-2 text-xs">{{ s.trajeto }}</td>
</tr>
{% endfor %}
{% else %}
<tr><td colspan="5" class="text-center p-4 text-gray-500 text-sm">Nenhuma viagem.</td></tr>
{% endif %}
</tbody>
</table>
</div>
</div>
</main>
</div>
</div>
<div id="modal-abastecer" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
<div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6">
<h2 class="text-xl font-bold mb-4">Registrar Abastecimento</h2>
<form id="form-abastecimento" class="space-y-3">
<div><label class="block text-xs font-semibold mb-2">Motorista</label><input list="motoristas-list" id="veiculo-refuel-motorista" class="w-full px-3 py-2 rounded-xl border-2 border-gray-200 text-sm" placeholder="Nome"><datalist id="motoristas-list"></datalist></div>
<div><label class="block text-xs font-semibold mb-2">Litros</label><input type="number" step="0.1" id="refuel-litros" class="w-full px-3 py-2 rounded-xl border-2 border-gray-200 text-sm" placeholder="0.00"></div>
<div><label class="block text-xs font-semibold mb-2">Od√¥metro</label><input type="number" id="refuel-odometro" class="w-full px-3 py-2 rounded-xl border-2 border-gray-200 text-sm" placeholder="0"></div>
<div><label class="block text-xs font-semibold mb-2">Observa√ß√£o</label><textarea id="refuel-observacao" rows="2" class="w-full px-3 py-2 rounded-xl border-2 border-gray-200 text-sm"></textarea></div>
<div class="flex gap-2 pt-2">
<button type="button" id="cancel-abastecer" class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-xl font-semibold text-sm">Cancelar</button>
<button type="submit" id="save-abastecer" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-xl font-semibold text-sm">Salvar</button>
</div>
</form>
</div>
</div>
<div id="modal-edit-refuel" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
<div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6">
<h2 class="text-xl font-bold mb-4">Editar Abastecimento</h2>
<form id="form-edit-refuel" class="space-y-3">
<div><label class="block text-xs font-semibold mb-2">Motorista</label><input type="text" id="edit-refuel-motorista" class="w-full px-3 py-2 rounded-xl border-2 border-gray-200 text-sm"></div>
<div><label class="block text-xs font-semibold mb-2">Litros</label><input type="number" step="0.1" id="edit-refuel-litros" class="w-full px-3 py-2 rounded-xl border-2 border-gray-200 text-sm"></div>
<div><label class="block text-xs font-semibold mb-2">Od√¥metro</label><input type="number" id="edit-refuel-odometro" class="w-full px-3 py-2 rounded-xl border-2 border-gray-200 text-sm"></div>
<div><label class="block text-xs font-semibold mb-2">Observa√ß√£o</label><textarea id="edit-refuel-observacao" rows="2" class="w-full px-3 py-2 rounded-xl border-2 border-gray-200 text-sm"></textarea></div>
<div class="flex gap-2 pt-2">
<button type="button" id="cancel-edit-refuel" class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-xl font-semibold text-sm">Cancelar</button>
<button type="button" id="save-edit-refuel" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-xl font-semibold text-sm">Atualizar</button>
</div>
</form>
</div>
</div>
<script>
const placa = "{{ placa }}";
let refuelsPage = 1, refuelsPageSize = 10, currentEditId = null;
function formatarData(isoString) { if (!isoString) return '-'; const d = new Date(isoString); return d.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }); }
const modalAbastecer = document.getElementById('modal-abastecer');
const btnAbastecer = document.getElementById('btn-abastecer');
const btnCancelAbastecer = document.getElementById('cancel-abastecer');
btnAbastecer.addEventListener('click', () => modalAbastecer.classList.remove('hidden'));
btnCancelAbastecer.addEventListener('click', () => modalAbastecer.classList.add('hidden'));
const modalEditRefuel = document.getElementById('modal-edit-refuel');
const btnCancelEditRefuel = document.getElementById('cancel-edit-refuel');
const btnSaveEditRefuel = document.getElementById('save-edit-refuel');
btnCancelEditRefuel.addEventListener('click', () => modalEditRefuel.classList.add('hidden'));
async function loadMotoristasList() { try { const res = await fetch('/api/motoristas'); if (!res.ok) return; const list = await res.json(); const datalist = document.getElementById('motoristas-list'); if (!datalist) return; datalist.innerHTML = ''; list.forEach(m => { const nome = m.nome || m; const opt = document.createElement('option'); opt.value = nome; datalist.appendChild(opt); }); } catch (err) { console.error('Erro motoristas', err); } }
async function loadVehicleData() { try { const res = await fetch(`/api/veiculos/${encodeURIComponent(placa)}`); if (res.ok) { const v = await res.json(); if (v.media_kmpl) { document.getElementById('input-media-kmpl').value = v.media_kmpl; document.getElementById('metric-kmpl').textContent = v.media_kmpl; } } } catch (e) { console.error('Erro ve√≠culo', e); } }
document.getElementById('save-media-kmpl').addEventListener('click', async () => { const val = document.getElementById('input-media-kmpl').value; if (!val) { alert('Informe km/L'); return; } try { const res = await fetch(`/api/veiculos/${encodeURIComponent(placa)}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ media_kmpl: Number(val) }) }); const j = await res.json(); if (res.ok) { alert('Atualizado!'); document.getElementById('metric-kmpl').textContent = Number(val).toFixed(2); loadMetrics(); } else { alert(j.error || 'Erro'); } } catch (err) { alert('Erro'); } });
async function loadMetrics() { try { const res = await fetch(`/api/veiculos/${encodeURIComponent(placa)}/metrics`); if (res.ok) { const m = await res.json(); document.getElementById('metric-ultimo-odometro').textContent = m.ultimo_odometro || '-'; document.getElementById('metric-total-litros').textContent = (m.total_litros || 0).toFixed(2); document.getElementById('metric-km-rodados').textContent = m.km_rodados ? m.km_rodados.toFixed(2) : '-'; } } catch (e) { console.error('Erro m√©tricas', e); } }
async function loadRefuelsPage(page = 1, pageSize = 10) { try { refuelsPage = page; refuelsPageSize = pageSize; const res = await fetch(`/api/veiculos/${encodeURIComponent(placa)}/refuels?page=${page}&page_size=${pageSize}`); if (!res.ok) { document.getElementById('refuels-tbody').innerHTML = '<tr><td colspan="6" class="text-center p-4 text-red-500 text-sm">Erro. Crie o √≠ndice do Firestore.</td></tr>'; return; } const payload = await res.json(); const items = payload.items || []; const tbody = document.getElementById('refuels-tbody'); tbody.innerHTML = ''; if (items.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-gray-500 text-sm">Nenhum registro.</td></tr>'; } else { items.forEach(it => { const tr = document.createElement('tr'); tr.className = 'hover:bg-gray-50 border-b'; tr.innerHTML = `<td class="p-2 text-xs">${formatarData(it.timestamp)}</td><td class="p-2 text-xs">${it.motorista || '-'}</td><td class="p-2 text-xs">${it.litros ? Number(it.litros).toFixed(2) : '-'}</td><td class="p-2 text-xs">${it.odometro ? Number(it.odometro) : '-'}</td><td class="p-2 text-xs hidden md:table-cell">${it.observacao || ''}</td><td class="p-2"><button class="btn-edit text-blue-600 mr-2 text-xs" data-id="${it._id}">‚úèÔ∏è</button><button class="btn-delete text-red-600 text-xs" data-id="${it._id}">üóëÔ∏è</button></td>`; tbody.appendChild(tr); }); } const pagination = document.getElementById('refuels-pagination'); pagination.innerHTML = ''; const total = payload.total || 0; const totalPages = Math.max(1, Math.ceil(total / pageSize)); const prev = document.createElement('button'); prev.textContent = '‚Üê'; prev.disabled = page <= 1; prev.className = `px-3 py-1 rounded text-xs ${page <= 1 ? 'bg-gray-200 text-gray-400' : 'bg-gray-300 text-gray-700 hover:bg-gray-400'}`; prev.addEventListener('click', () => loadRefuelsPage(page - 1, pageSize)); const next = document.createElement('button'); next.textContent = '‚Üí'; next.disabled = page >= totalPages; next.className = `px-3 py-1 rounded text-xs ${page >= totalPages ? 'bg-gray-200 text-gray-400' : 'bg-gray-300 text-gray-700 hover:bg-gray-400'}`; next.addEventListener('click', () => loadRefuelsPage(page + 1, pageSize)); const info = document.createElement('span'); info.textContent = `${page}/${totalPages}`; info.className = 'px-2 text-gray-600 text-xs'; pagination.appendChild(prev); pagination.appendChild(info); pagination.appendChild(next); document.querySelectorAll('.btn-edit').forEach(b => b.addEventListener('click', openEditRefuel)); document.querySelectorAll('.btn-delete').forEach(b => b.addEventListener('click', confirmDeleteRefuel)); } catch (err) { console.error('Erro refuels', err); } }
document.getElementById('refuels-page-size').addEventListener('change', (e) => loadRefuelsPage(1, Number(e.target.value)));
document.getElementById('form-abastecimento').addEventListener('submit', async (e) => { e.preventDefault(); const motorista = document.getElementById('veiculo-refuel-motorista').value.trim(); const litros = document.getElementById('refuel-litros').value; const odometro = document.getElementById('refuel-odometro').value; const observacao = document.getElementById('refuel-observacao').value; if (!litros && !odometro) { alert('Informe litros ou od√¥metro'); return; } try { const res = await fetch('/api/veiculos/refuels', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ veiculo: placa, motorista, litros: litros ? Number(litros) : null, odometro: odometro ? Number(odometro) : null, observacao }) }); const json = await res.json(); if (res.ok) { alert('Registrado!'); modalAbastecer.classList.add('hidden'); document.getElementById('veiculo-refuel-motorista').value = ''; document.getElementById('refuel-litros').value = ''; document.getElementById('refuel-odometro').value = ''; document.getElementById('refuel-observacao').value = ''; loadRefuelsPage(refuelsPage, refuelsPageSize); loadMetrics(); } else { alert(json.error || 'Erro'); } } catch (err) { alert('Erro'); } });
async function openEditRefuel(e) { const id = e.currentTarget.dataset.id; currentEditId = id; try { const res = await fetch(`/api/veiculos/${encodeURIComponent(placa)}/refuels?page=${refuelsPage}&page_size=${refuelsPageSize}`); const p = await res.json(); const found = (p.items || []).find(x => x._id === id); if (found) { document.getElementById('edit-refuel-motorista').value = found.motorista || ''; document.getElementById('edit-refuel-litros').value = found.litros ?? ''; document.getElementById('edit-refuel-odometro').value = found.odometro ?? ''; document.getElementById('edit-refuel-observacao').value = found.observacao || ''; modalEditRefuel.classList.remove('hidden'); } } catch (err) { console.error(err); } }
btnSaveEditRefuel.addEventListener('click', async () => { if (!currentEditId) return; const motorista = document.getElementById('edit-refuel-motorista').value.trim(); const litros = document.getElementById('edit-refuel-litros').value; const odometro = document.getElementById('edit-refuel-odometro').value; const observacao = document.getElementById('edit-refuel-observacao').value; try { const res = await fetch(`/api/refuels/${currentEditId}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ motorista, litros: litros ? Number(litros) : null, odometro: odometro ? Number(odometro) : null, observacao }) }); const j = await res.json(); if (res.ok) { alert('Atualizado!'); modalEditRefuel.classList.add('hidden'); loadRefuelsPage(refuelsPage, refuelsPageSize); loadMetrics(); } else { alert(j.error || 'Erro'); } } catch (err) { alert('Erro'); } });
function confirmDeleteRefuel(e) { const id = e.currentTarget.dataset.id; if (!confirm('Confirma exclus√£o?')) return; fetch(`/api/refuels/${id}`, { method: 'DELETE' }).then(async r => { const j = await r.json(); if (r.ok) { alert('Removido!'); loadRefuelsPage(refuelsPage, refuelsPageSize); loadMetrics(); } else { alert(j.error || 'Erro'); } }).catch(err => alert('Erro')); }
loadMotoristasList();
loadVehicleData();
loadMetrics();
loadRefuelsPage(1, 10);
</script>
</body>
</html>
